name: Import Publications From Bibtex

permissions:
  contents: write
  pull-requests: write

on:
  push:
    branches: [main]
    paths:
      - publications.bib
  workflow_dispatch:

concurrency:
  group: import-publications
  cancel-in-progress: true

jobs:
  hugoblox:
    if: github.repository_owner != 'HugoBlox'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install importer
        run: |
          python -m pip install --upgrade pip
          pip install academic==0.10.0 pyyaml

      - name: Import publications (BibTeX → Markdown)
        if: ${{ hashFiles('publications.bib') != '' }}
        run: |
          academic import publications.bib content/publication/ --compact

            - name: Add "Publisher" button from DOI (links:)
        if: ${{ hashFiles('content/publication/**/index.md') != '' }}
        run: |
          python - <<'PY'
          import glob, re
          import yaml

          def split_front_matter(s: str):
              if not s.startswith('---'):
                  return None, s
              parts = s.split('---', 2)
              if len(parts) < 3:
                  return None, s
              return parts[1].strip(), parts[2]

          def norm_doi(doi: str) -> str:
              doi = (doi or "").strip()
              doi = re.sub(r'^(https?://(dx\.)?doi\.org/)', '', doi, flags=re.I)
              return doi.strip()

          updated = 0
          for path in glob.glob('content/publication/**/index.md', recursive=True):
              with open(path, 'r', encoding='utf-8') as f:
                  text = f.read()

              fm_text, body = split_front_matter(text)
              if fm_text is None:
                  continue

              data = yaml.safe_load(fm_text) or {}
              doi = norm_doi(str(data.get('doi', '') or ''))
              if not doi:
                  continue

              target = f"https://doi.org/{doi}"

              links = data.get('links')
              if links is None:
                  links = []
              # If links is not a list, skip safely
              if not isinstance(links, list):
                  continue

              # Don’t duplicate
              already = any((isinstance(x, dict) and (x.get('url') == target or str(x.get('url','')).endswith(doi))) for x in links)
              if not already:
                  links.insert(0, {"name": "Publisher", "url": target})
                  data['links'] = links
                  updated += 1

              new_fm = yaml.safe_dump(data, sort_keys=False, allow_unicode=True).strip()
              new_text = f"---\n{new_fm}\n---{body}"
              if new_text != text:
                  with open(path, 'w', encoding='utf-8') as f:
                      f.write(new_text)

          print(f"Added/updated Publisher links for {updated} publication pages.")
          PY


      - name: Disable author hyperlinks (theme override)
        run: |
          mkdir -p layouts/partials
          cat > layouts/partials/page_metadata_authors.html <<'EOF'
          {{/* Override: render authors as plain text (no links) */}}
          {{- $page := .page | default . -}}
          {{- $authors := $page.Params.authors | default (slice) -}}
          {{- if gt (len $authors) 0 -}}
            <span class="authors">
              {{- range $i, $a := $authors -}}
                {{- if gt $i 0 -}}, {{ end -}}
                {{- $a -}}
              {{- end -}}
            </span>
          {{- end -}}
          EOF

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "content: import publications from BibTeX"
          title: "Hugo Blox Builder - Import latest publications"
          body: |
            Imports publications from `publications.bib` into `content/publication/`.

            Post-processing included:
            - Add `url: https://doi.org/<doi>` when a DOI exists (enables a Publisher/DOI button).
            - Disable author name hyperlinks via `layouts/partials/page_metadata_authors.html`.
          base: main
          labels: automated-pr, content
          branch: hugoblox-import-publications
          delete-branch: true

      - name: Report PR URL
        if: ${{ steps.cpr.outputs.pull-request-number }}
        run: |
          echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
          echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"
