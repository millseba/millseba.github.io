name: Import Publications From Bibtex

permissions:
  contents: write
  pull-requests: write

on:
  push:
    branches: [main]
    paths:
      - publications.bib
  workflow_dispatch:

concurrency:
  group: import-publications
  cancel-in-progress: true

jobs:
  hugoblox:
    if: github.repository_owner != 'HugoBlox'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install importer
        run: |
          python -m pip install --upgrade pip
          pip install academic==0.10.0 requests pyyaml

      - name: Import publications (BibTeX â†’ Markdown)
        if: ${{ hashFiles('publications.bib') != '' }}
        run: |
          academic import publications.bib content/publication/ --compact

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install academic==0.10.0 pyyaml bibtexparser

      - name: Inject DOI + publisher link from publications.bib
        if: ${{ hashFiles('publications.bib') != '' && hashFiles('content/publication/**/index.md') != '' }}
        run: |
          python - <<'PY'
          import re, glob
          import yaml
          import bibtexparser

          def split_fm(text: str):
              if not text.startswith('---'):
                  return None, text
              parts = text.split('---', 2)
              if len(parts) < 3:
                  return None, text
              return parts[1].strip(), parts[2]

          def clean_title(t: str) -> str:
              t = (t or "").strip()
              t = re.sub(r"[{}]", "", t)           # remove BibTeX braces
              t = re.sub(r"\s+", " ", t)
              return t.lower()

          def norm_doi(d: str) -> str:
              d = (d or "").strip()
              d = re.sub(r'^(https?://(dx\.)?doi\.org/)', '', d, flags=re.I)
              return d.strip()

          # --- Read BibTeX and build a title->doi map
          with open("publications.bib", "r", encoding="utf-8") as f:
              bib_db = bibtexparser.load(f)

          title_to_doi = {}
          for e in bib_db.entries:
              title = clean_title(e.get("title", ""))
              doi = norm_doi(e.get("doi", ""))
              if title and doi:
                  title_to_doi[title] = doi

          updated = 0
          missing = 0

          for path in glob.glob("content/publication/**/index.md", recursive=True):
              with open(path, "r", encoding="utf-8") as f:
                  txt = f.read()
              fm, body = split_fm(txt)
              if fm is None:
                  continue
              data = yaml.safe_load(fm) or {}

              page_title = clean_title(data.get("title", ""))
              doi = norm_doi(str(data.get("doi", "") or ""))

              if not doi:
                  doi = title_to_doi.get(page_title, "")

              if doi:
                  data["doi"] = doi
                  target = f"https://doi.org/{doi}"
                  data.setdefault("url_source", target)
                  data.setdefault("url", target)
                  updated += 1
              else:
                  missing += 1

              new_fm = yaml.safe_dump(data, sort_keys=False, allow_unicode=True).strip()
              new_txt = f"---\n{new_fm}\n---{body}"
              if new_txt != txt:
                  with open(path, "w", encoding="utf-8") as f:
                      f.write(new_txt)

          print(f"Injected DOI into {updated} pages; {missing} pages still missing DOI.")
          PY


      - name: Add Publisher button from DOI (links:)
        if: ${{ hashFiles('content/publication/**/index.md') != '' }}
        run: |
          python - <<'PY'
          import glob, re, yaml

          def split_fm(s):
              if not s.startswith('---'): return None, s
              a = s.split('---', 2)
              return (a[1].strip(), a[2]) if len(a) >= 3 else (None, s)

          def norm_doi(d):
              d = (d or "").strip()
              return re.sub(r'^(https?://(dx\.)?doi\.org/)', '', d, flags=re.I).strip()

          for path in glob.glob('content/publication/**/index.md', recursive=True):
              txt = open(path, encoding='utf-8').read()
              fm, body = split_fm(txt)
              if fm is None: continue
              data = yaml.safe_load(fm) or {}

              doi = norm_doi(str(data.get('doi','') or ''))
              if not doi: continue
              target = f"https://doi.org/{doi}"

              links = data.get('links') or []
              if not isinstance(links, list): continue
              if not any(isinstance(x, dict) and x.get('url') == target for x in links):
                  links.insert(0, {"name": "Publisher", "url": target})
                  data['links'] = links

              newfm = yaml.safe_dump(data, sort_keys=False, allow_unicode=True).strip()
              open(path, 'w', encoding='utf-8').write(f"---\n{newfm}\n---{body}")
          PY


      - name: Disable author hyperlinks (theme override)
        run: |
          mkdir -p layouts/partials
          cat > layouts/partials/page_metadata_authors.html <<'EOF'
          {{/* Override: render authors as plain text (no links) */}}
          {{- $p := . -}}
          {{- $authors := $p.Params.authors | default (slice) -}}
          {{- if gt (len $authors) 0 -}}
            <span class="authors">
              {{- range $i, $a := $authors -}}
                {{- if gt $i 0 -}}, {{ end -}}
                {{- $a -}}
              {{- end -}}
            </span>
          {{- end -}}
          EOF

      - name: Create Pull Request
        id: cpr
        uses: peter-evans/create-pull-request@v6
        with:
          commit-message: "content: import publications from BibTeX"
          title: "Hugo Blox Builder - Import latest publications"
          body: |
            Imports publications from `publications.bib` into `content/publication/`.

            Post-processing included:
            - Add `url: https://doi.org/<doi>` when a DOI exists (enables a Publisher/DOI button).
            - Disable author name hyperlinks via `layouts/partials/page_metadata_authors.html`.
          base: main
          labels: automated-pr, content
          branch: hugoblox-import-publications
          delete-branch: true

      - name: Report PR URL
        if: ${{ steps.cpr.outputs.pull-request-number }}
        run: |
          echo "Pull Request Number - ${{ steps.cpr.outputs.pull-request-number }}"
          echo "Pull Request URL - ${{ steps.cpr.outputs.pull-request-url }}"
